<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse - AI Personal Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        #chat-view::-webkit-scrollbar {
            width: 8px;
        }
        #chat-view::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-view::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chat-view::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .pulse-loader {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 2px solid #FFF;
            box-sizing: border-box;
            animation: pulse-loader 1s linear infinite;
        }
        .pulse-loader::after {
            content: '';
            position: absolute;
            width: 48px;
            height: 48px;
            border: 2px solid #FFF;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-loader-sub 1s linear infinite;
        }

        @keyframes pulse-loader {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes pulse-loader-sub {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        /* Styling for paragraphs and lists inside AI messages */
        .ai-message-content p {
            margin-bottom: 0.5rem;
        }
        .ai-message-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
        }
        .ai-message-content li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen font-sans">

<div id="app-container" class="w-full max-w-2xl h-full sm:h-[90vh] bg-white rounded-2xl shadow-2xl flex flex-col p-6">

    <div id="onboarding-view" class="flex flex-col items-center justify-center h-full text-center">
        <h1 class="text-4xl font-bold text-gray-800">Welcome to Pulse! ⚡️</h1>
        <p class="text-gray-600 mt-4">Before we start, let me get some basic information to personalize your plan.</p>
        <div class="w-full max-w-md mt-8 space-y-4">
            <div>
                <label for="height-field" class="sr-only">Height</label>
                <input id="height-field" type="text" placeholder="Height (e.g., 5'10&quot; or 178cm)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="weight-field" class="sr-only">Weight</label>
                <input id="weight-field" type="text" placeholder="Weight (e.g., 175 lbs or 80 kg)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="age-field" class="sr-only">Age</label>
                <input id="age-field" type="number" placeholder="Age" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="ethnicity-field" class="sr-only">Ethnicity</label>
                <input id="ethnicity-field" type="text" placeholder="Ethnicity" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="start-chat-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Create My Plan →</button>
        </div>
    </div>

    <div id="chat-view-container" class="hidden flex-col h-full">
        <h1 class="text-2xl font-bold text-center text-gray-800 pb-4 border-b">Pulse AI Trainer</h1>
        <div id="chat-view" class="flex-grow overflow-y-auto p-4 space-y-4">
        </div>
        <div class="mt-4 flex items-center space-x-2">
            <label for="message-input" class="sr-only">Your message</label>
            <input id="message-input" type="text" placeholder="What are your fitness goals today?" class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="send-button" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition duration-300">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = "http://127.0.0.1:8000/chat";
        let chatHistory = [];

        const onboardingView = document.getElementById('onboarding-view');
        const chatViewContainer = document.getElementById('chat-view-container');
        const chatView = document.getElementById('chat-view');

        const heightField = document.getElementById('height-field');
        const weightField = document.getElementById('weight-field');
        const ageField = document.getElementById('age-field');
        const ethnicityField = document.getElementById('ethnicity-field');
        const startChatBtn = document.getElementById('start-chat-btn');

        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        const scrollToBottom = () => {
            chatView.scrollTop = chatView.scrollHeight;
        };

        const showTypingIndicator = (show) => {
            let indicator = document.getElementById('typing-indicator');
            if (show) {
                if (!indicator) {
                    const typingHtml = `
                        <div id="typing-indicator" class="flex items-center space-x-2">
                            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><span class="pulse-loader"></span></div>
                            <div class="p-3 bg-gray-200 rounded-2xl text-gray-700">Pulse is typing...</div>
                        </div>
                    `;
                    chatView.insertAdjacentHTML('beforeend', typingHtml);
                    scrollToBottom();
                }
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        };

        const addMessage = (message, isUser) => {
            const alignClass = isUser ? 'justify-end' : 'justify-start';
            const colorClass = isUser ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800';

            const content = isUser ? message : marked.parse(message);
            const contentWrapperClass = isUser ? '' : 'ai-message-content';

            const messageHtml = `
                <div class="flex ${alignClass}">
                    <div class="max-w-md p-3 rounded-2xl ${colorClass}">
                        <div class="${contentWrapperClass}">${content}</div>
                    </div>
                </div>
            `;
            chatView.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        };

        const addWorkoutPlan = (plan) => {
            const exercisesHtml = plan.exercises.map(ex => `
                <li class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span><strong>${ex.name}:</strong> ${ex.sets} sets of ${ex.reps}, with ${ex.rest_period} rest.</span>
                </li>
            `).join('');

            const planHtml = `
                <div class="border border-green-400 bg-green-50 rounded-2xl p-6 my-4">
                    <h2 class="text-2xl font-bold text-gray-800">${plan.title}</h2>
                    <p class="text-gray-600 italic">Goal: ${plan.goal} (${plan.workout_type})</p>
                    <hr class="my-4">
                    <ul class="space-y-2">
                        ${exercisesHtml}
                    </ul>
                    <hr class="my-4">
                    <p class="font-bold">✨ Pulse's Note:</p>
                    <p class="text-gray-700">${plan.final_note}</p>
                </div>
            `;
            chatView.insertAdjacentHTML('beforeend', planHtml);
            scrollToBottom();
        };

        const sendMessage = async () => {
            const query = messageInput.value.trim();
            if (!query) return;

            addMessage(query, true);
            messageInput.value = '';
            showTypingIndicator(true);

            const payload = { query, chat_history: chatHistory };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                showTypingIndicator(false);
                chatHistory.push({ type: 'human', content: query });

                if (result.type === 'workout_plan') {
                    addWorkoutPlan(result.data);
                    chatHistory.push({ type: 'ai', content: JSON.stringify(result.data) });
                } else {
                    addMessage(result.data, false);
                    chatHistory.push({ type: 'ai', content: result.data });
                }
            } catch (error) {
                showTypingIndicator(false);
                addMessage(`Error: Could not connect to the trainer. Make sure the backend server is running. (${error.message})`, false);
            }
        };

        startChatBtn.addEventListener('click', () => {
            const height = heightField.value;
            const weight = weightField.value;
            const age = ageField.value;
            const ethnicity = ethnicityField.value;

            if (!height || !weight || !age || !ethnicity) {
                alert('Please fill out all fields.');
                return;
            }

            const userProfileSummary = `To start, here is my profile - Height: ${height}, Weight: ${weight}, Age: ${age}, Ethnicity: ${ethnicity}.`;
            chatHistory.push({ type: 'human', content: userProfileSummary });

            onboardingView.classList.add('hidden');
            chatViewContainer.classList.remove('hidden');
            chatViewContainer.classList.add('flex');

            messageInput.value = `My goal is to get a personalized workout plan. My profile is: Height: ${height}, Weight: ${weight}, Age: ${age}, Ethnicity: ${ethnicity}.`;
            sendMessage();
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });
</script>
</body>
</html>